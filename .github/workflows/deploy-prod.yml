name: Promote staging to prod

on:
  workflow_dispatch:   # manual run in GitHub UI

permissions:
  id-token: write
  contents: read

jobs:
  promote-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Promote staging to prod
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          USER: ${{ secrets.DEPLOY_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST "
            set -e

            echo '[PROD] Fixing permissions for container user (UID 1002)...'
            # Try without sudo first (if user owns the directory or it's already writable)
            if chown -R 1002:1002 /srv/zana-users 2>/dev/null || chmod -R 777 /srv/zana-users 2>/dev/null; then
              echo '[PROD] Permissions fixed without sudo'
            elif sudo -n chown -R 1002:1002 /srv/zana-users 2>/dev/null || sudo -n chmod -R 777 /srv/zana-users 2>/dev/null; then
              echo '[PROD] Permissions fixed with passwordless sudo'
            else
              echo '[PROD] WARNING: Could not fix permissions. Directory may already have correct permissions.'
              echo '[PROD] If deployment fails, configure passwordless sudo or fix permissions manually.'
            fi

            echo '[PROD] Changing to project directory...'
            cd $PROJECT_PATH

            echo '[PROD] Checking if staging image exists...'
            if ! docker images | grep -q 'zana-ai-bot.*staging'; then
              echo '[PROD] ERROR: Staging image not found. Please deploy to staging first.'
              exit 1
            fi

            echo '[PROD] Tagging zana-ai-bot:staging as zana-ai-bot:prod...'
            docker tag zana-ai-bot:staging zana-ai-bot:prod

            echo '[PROD] Restarting production container...'
            docker compose up -d zana-prod

            echo '[PROD] Done.'
          "

      - name: Tag production deployment
        if: success()
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          USER: ${{ secrets.DEPLOY_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST "
            cd $PROJECT_PATH
            COMMIT_SHA=\$(git rev-parse --short HEAD)
            TIMESTAMP=\$(date +%Y%m%d-%H%M%S)
            TAG=\"prod-\${TIMESTAMP}-\${COMMIT_SHA}\"
            git tag -a \"\$TAG\" -m \"Production deployment: \$(date)\" || true
            git push origin \"\$TAG\" || true
            echo \"Tagged as: \$TAG\"
          "
