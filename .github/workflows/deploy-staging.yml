name: Deploy to Staging on GCP

on:
  push:
    branches:
      - master

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy staging
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          USER: ${{ secrets.DEPLOY_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no "$USER@$HOST" "bash -s -- '$PROJECT_PATH'" <<'REMOTE_SCRIPT'
            set -euo pipefail
            PROJECT_PATH="$1"

            echo '[STAGING] Preparing staging data...'
            if mkdir -p /srv/zana-users-staging /srv/zana-logs-staging 2>/dev/null; then
              echo '[STAGING] Created staging directories without sudo'
            elif sudo -n mkdir -p /srv/zana-users-staging /srv/zana-logs-staging 2>/dev/null; then
              echo '[STAGING] Created staging directories with sudo'
            else
              echo '[STAGING] ERROR: Could not create staging directories (need permissions or passwordless sudo)'
              exit 1
            fi

            rm -rf /srv/zana-users-staging/* 2>/dev/null || sudo -n rm -rf /srv/zana-users-staging/* 2>/dev/null || true
            cp -r /srv/zana-users/* /srv/zana-users-staging/ 2>/dev/null || sudo -n cp -r /srv/zana-users/* /srv/zana-users-staging/ 2>/dev/null || true

            echo '[STAGING] Fixing permissions for container user (UID 1002)...'
            for dir in /srv/zana-users-staging /srv/zana-logs-staging; do
              if chown -R 1002:1002 "$dir" 2>/dev/null || chmod -R 777 "$dir" 2>/dev/null; then
                echo "[STAGING] Permissions fixed for $dir without sudo"
              elif sudo -n chown -R 1002:1002 "$dir" 2>/dev/null || sudo -n chmod -R 777 "$dir" 2>/dev/null; then
                echo "[STAGING] Permissions fixed for $dir with sudo"
              else
                echo "[STAGING] WARNING: Could not fix permissions for $dir"
              fi
            done

            echo '[STAGING] Updating code...'
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "[STAGING] ERROR: Project path does not exist: $PROJECT_PATH"
              exit 1
            fi
            cd "$PROJECT_PATH"
            if [ ! -d .git ]; then
              echo "[STAGING] ERROR: Not a git repository at $PROJECT_PATH"
              exit 1
            fi

            # Handle stale git lock from interrupted operations.
            if [ -f .git/index.lock ]; then
              echo '[STAGING] Removing stale git lock file...'
              rm -f .git/index.lock 2>/dev/null || sudo -n rm -f .git/index.lock 2>/dev/null || true
            fi

            # Check if we're in detached HEAD state (e.g. git checkout <commit>).
            CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo HEAD)"
            if [ "$CURRENT_BRANCH" = "HEAD" ]; then
              echo '[STAGING] Detected detached HEAD state, switching to master...'
              git fetch origin master 2>/dev/null || git fetch origin
              git checkout master 2>/dev/null || git checkout -b master origin/master
            fi

            # Fetch latest changes and reset to origin/master (ensures clean state).
            echo '[STAGING] Fetching and updating to latest master...'
            git fetch origin master || git fetch origin
            git reset --hard origin/master

            echo '[STAGING] Rebuilding containers with BuildKit (cached layers)...'
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            # Compute runtime metadata used by /version in staging.
            COMMIT_SHA="$(git rev-parse --short HEAD)"
            BUILD_DATE_UTC="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            export BOT_VERSION="$COMMIT_SHA"
            export BUILD_DATE="$BUILD_DATE_UTC"

            # Build bot container (zana-staging) with commit fallback in /app/VERSION.
            docker compose --progress plain build \
              --build-arg GIT_COMMIT="$COMMIT_SHA" \
              zana-staging

            # Build webapp container (includes frontend build in Dockerfile.webapp).
            docker compose --progress plain build zana-webapp

            # Start both containers.
            docker compose up -d zana-staging zana-webapp

            echo '[STAGING] Verifying containers are running...'
            sleep 10

            if docker compose ps zana-staging | grep -q 'Up'; then
              echo '[STAGING] OK: Bot container (zana-staging) is running'
            else
              echo '[STAGING] WARNING: Bot container (zana-staging) is not running - check logs: docker compose logs zana-staging'
            fi

            if docker compose ps zana-webapp | grep -q 'Up'; then
              echo '[STAGING] OK: Webapp container (zana-webapp) is running'
              HEALTH_CHECK_PASSED=false
              for i in 1 2 3; do
                if echo 'import urllib.request; urllib.request.urlopen("http://localhost:8080/api/health")' | docker compose exec -T zana-webapp python > /dev/null 2>&1; then
                  echo '[STAGING] OK: Webapp health check passed'
                  HEALTH_CHECK_PASSED=true
                  break
                else
                  echo "[STAGING] Health check attempt $i/3 failed, waiting 3 seconds..."
                  sleep 3
                fi
              done
              if [ "$HEALTH_CHECK_PASSED" = 'false' ]; then
                echo '[STAGING] WARNING: Webapp health endpoint not responding after retries - check logs: docker compose logs zana-webapp'
                echo '[STAGING] Container is running but health check failed - this may be a timing issue'
              fi
            else
              echo '[STAGING] WARNING: Webapp container (zana-webapp) is not running - check logs: docker compose logs zana-webapp'
            fi

            echo '[STAGING] Done.'
          REMOTE_SCRIPT

      - name: Tag staging deployment
        if: success()
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          USER: ${{ secrets.DEPLOY_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no "$USER@$HOST" "bash -s -- '$PROJECT_PATH'" <<'REMOTE_SCRIPT'
            set -euo pipefail
            PROJECT_PATH="$1"
            cd "$PROJECT_PATH"
            COMMIT_SHA="$(git rev-parse --short HEAD)"
            TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
            TAG="staging-${TIMESTAMP}-${COMMIT_SHA}"
            git tag -a "$TAG" -m "Staging deployment: $(date)" || true
            git push origin "$TAG" || true
            echo "Tagged as: $TAG"
          REMOTE_SCRIPT
