version: "3.9"

services:
  # =========================
  # PRODUCTION TELEGRAM BOT
  # =========================
  zana-prod:
    build:
      context: .
      dockerfile: Dockerfile
    image: zana-ai-bot:prod
    container_name: zana-prod
    env_file:
      - /opt/zana-config/.env.prod
    environment:
      - ENVIRONMENT=production
    volumes:
      - /srv/zana-users:/app/USERS_DATA_DIR
    restart: unless-stopped
    networks:
      - web

  # =========================
  # STAGING TELEGRAM BOT
  # =========================
  zana-staging:
    build:
      context: .
      dockerfile: Dockerfile
    image: zana-ai-bot:staging
    container_name: zana-staging
    env_file:
      - /opt/zana-config/.env.staging
    environment:
      - ENVIRONMENT=staging
    volumes:
      - /srv/zana-users-staging:/app/USERS_DATA_DIR
    restart: unless-stopped
    networks:
      - web

  # =========================
  # STATS / API SERVICE
  # (adapt this block to match your existing zana-stats config if needed)
  # =========================
  zana-stats:
    build:
      context: .
      dockerfile: stats_service/Dockerfile    # adjust if your stats Dockerfile is elsewhere
    container_name: zana-stats
    env_file:
      - /opt/zana-config/.env.staging                            # or keep your original path
    ports:
      - "8000:8000"
    restart: unless-stopped
    networks:
      - web

  # =========================
  # NEW WEBAPP (REAL WEBSITE)
  # =========================
  zana-webapp:
    build:
      context: .
      dockerfile: Dockerfile.webapp           # the new minimal webapp Dockerfile
    image: zana-project-webapp
    container_name: zana-webapp
    env_file:
      - /opt/zana-config/.env.staging                          # or .env.prod if you prefer
    # IMPORTANT: no host port here – nginx will reach it via Docker network
    expose:
      - "8080"                                # internal FastAPI/uvicorn port
    volumes:
      # Mount project source (excluding webapp_frontend source, using built dist instead)
      # Note: webapp_frontend/dist must be built on host before starting container
      - ./tm_bot:/app/tm_bot                  # Python backend code
      - ./assets:/app/assets                  # Static assets
      - ./run_webapp_local.py:/app/run_webapp_local.py  # Webapp entry point
      - ./webapp_frontend/dist:/app/webapp_frontend/dist  # Built frontend (must exist on host)
      - /srv/zana-users-staging:/app/USERS_DATA_DIR  # database mount (staging)
    working_dir: /app                       # important: match your dev run's -w /app
    #command: ["python", "run_webapp_local.py"]   # ← IMPORTANT
    command: ["uvicorn", "run_webapp_local:app", "--host", "0.0.0.0", "--port", "8080", "--reload"]
    #restart: unless-stopped
    networks:
      - web

  # =========================
  # NGINX REVERSE PROXY
  # Serves http://zana-ai.com → zana-webapp:8080
  # =========================
  nginx:
    image: nginx:alpine
    container_name: zana-nginx
    depends_on:
      - zana-webapp
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      # later for TLS:
      # - ./letsencrypt:/etc/letsencrypt:ro
    restart: unless-stopped
    networks:
      - web

  # =========================
  # DATABASE MONITORING (BOTH STAGING & PRODUCTION)
  # Access via SSH port forwarding: gcloud compute ssh vm-telegram-bot -- -L 8081:127.0.0.1:8081
  # Then open: http://localhost:8081
  # The interface will show both databases for selection
  # =========================
  zana-db-monitor:
    image: coleifer/sqlite-web:latest
    container_name: zana-db-monitor
    user: "0:0"
    # DEBUG MODE: Keep container running with shell for debugging
    # To debug: sudo docker exec -it zana-db-monitor /bin/sh
    # Then run: sqlite_web -H 127.0.0.1 -p 8081 -x /srv/zana-users/zana.db /srv/zana-users-staging/zana.db
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "=== DEBUG MODE: Container will keep running ===" && \
        echo "To debug, run: sudo docker exec -it zana-db-monitor /bin/sh" && \
        echo "" && \
        echo "Checking databases..." && \
        ls -lh /srv/zana-users/zana.db 2>&1 && \
        ls -lh /srv/zana-users-staging/zana.db 2>&1 && \
        echo "" && \
        echo "Testing database access..." && \
        sqlite3 /srv/zana-users/zana.db "SELECT 1;" 2>&1 && echo "Production DB: OK" || echo "Production DB: FAILED" && \
        sqlite3 /srv/zana-users-staging/zana.db "SELECT 1;" 2>&1 && echo "Staging DB: OK" || echo "Staging DB: FAILED" && \
        echo "" && \
        echo "Testing sqlite-web command..." && \
        which sqlite_web && \
        sqlite_web --help 2>&1 | head -10 && \
        echo "" && \
        echo "Attempting to start sqlite-web (checking error)..." && \
        sqlite_web -H 127.0.0.1 -p 8081 -x /srv/zana-users/zana.db /srv/zana-users-staging/zana.db 2>&1 || \
        (echo "" && echo "=== sqlite-web failed with error above ===" && echo "Container will stay alive. Run: sudo docker exec -it zana-db-monitor /bin/sh" && while true; do sleep 3600; done)
    volumes:
      - /srv/zana-users:/srv/zana-users:ro
      - /srv/zana-users-staging:/srv/zana-users-staging:ro
    ports:
      - "127.0.0.1:8081:8081"
    restart: "no"
    networks:
      - web

networks:
  web:
    driver: bridge
