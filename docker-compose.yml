services:
  # =========================
  # PRODUCTION TELEGRAM BOT
  # =========================
  zana-prod:
    build:
      context: .
      dockerfile: Dockerfile
    image: zana-ai-bot:prod
    container_name: zana-prod
    depends_on:
      - qdrant
    env_file:
      - /opt/zana-config/.env.prod
    environment:
      - ENVIRONMENT=production
      - LOG_FILE_PATH=/app/logs/zana.log
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-content_chunks_v1}
      - VERTEX_EMBEDDING_MODEL=${VERTEX_EMBEDDING_MODEL:-gemini-embedding-001}
      - BRAVE_SEARCH_API_KEY=${BRAVE_SEARCH_API_KEY:-}
      # DATABASE_URL_PROD should be set in .env.prod
    volumes:
      - /srv/zana-users:/app/USERS_DATA_DIR
      - /srv/zana-logs-prod:/app/logs
    restart: unless-stopped
    networks:
      - web

  # =========================
  # STAGING TELEGRAM BOT
  # =========================
  zana-staging:
    build:
      context: .
      dockerfile: Dockerfile
    image: zana-ai-bot:staging
    container_name: zana-staging
    depends_on:
      - qdrant
    env_file:
      - /opt/zana-config/.env.staging
    environment:
      - ENVIRONMENT=staging
      - LOG_FILE_PATH=/app/logs/zana.log
      - BOT_VERSION=${BOT_VERSION:-}
      - BUILD_DATE=${BUILD_DATE:-}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-content_chunks_v1}
      - VERTEX_EMBEDDING_MODEL=${VERTEX_EMBEDDING_MODEL:-gemini-embedding-001}
      - BRAVE_SEARCH_API_KEY=${BRAVE_SEARCH_API_KEY:-}
      # DATABASE_URL_STAGING should be set in .env.staging
    volumes:
      - /srv/zana-users-staging:/app/USERS_DATA_DIR
      - /srv/zana-logs-staging:/app/logs
    restart: unless-stopped
    networks:
      - web

  # =========================
  # STATS / API SERVICE
  # (adapt this block to match your existing zana-stats config if needed)
  # =========================
  zana-stats:
    build:
      context: .
      dockerfile: stats_service/Dockerfile    # adjust if your stats Dockerfile is elsewhere
    container_name: zana-stats
    env_file:
      - /opt/zana-config/.env.staging                            # or keep your original path
    ports:
      - "8000:8000"
    restart: unless-stopped
    networks:
      - web

  # =========================
  # NEW WEBAPP (REAL WEBSITE)
  # =========================
  zana-webapp:
    build:
      context: .
      dockerfile: Dockerfile.webapp           # the new minimal webapp Dockerfile
    image: zana-project-webapp
    container_name: zana-webapp
    depends_on:
      - qdrant
    env_file:
      - /opt/zana-config/.env.prod            # Production environment
    environment:
      - CONTENT_LEARNING_PIPELINE_ENABLED=${CONTENT_LEARNING_PIPELINE_ENABLED:-0}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-content_chunks_v1}
      - VERTEX_EMBEDDING_MODEL=${VERTEX_EMBEDDING_MODEL:-gemini-embedding-001}
    # IMPORTANT: no host port here – nginx will reach it via Docker network
    expose:
      - "8080"                                # internal FastAPI/uvicorn port
    volumes:
      - /srv/zana-users:/app/USERS_DATA_DIR
    # Production-style: no source bind-mounts.
    # Frontend is built inside Docker (Dockerfile.webapp) and served from /app/webapp_frontend/dist.
    # Database connection via DATABASE_URL_PROD in .env.prod
    working_dir: /app                       # important: match your dev run's -w /app
    #command: ["python", "run_webapp_local.py"]   # ← IMPORTANT
    command: ["uvicorn", "run_webapp_local:app", "--host", "0.0.0.0", "--port", "8080"]
    restart: unless-stopped
    networks:
      - web

  # =========================
  # VECTOR SEARCH (Qdrant)
  # =========================
  qdrant:
    image: qdrant/qdrant:v1.13.2
    container_name: zana-qdrant
    expose:
      - "6333"
      - "6334"
    volumes:
      - qdrant-storage:/qdrant/storage
    restart: unless-stopped
    networks:
      - web

  # =========================
  # NGINX REVERSE PROXY
  # Serves http://xaana.club → zana-webapp:8080
  # =========================
  nginx:
    image: nginx:alpine
    container_name: zana-nginx
    depends_on:
      - zana-webapp
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      # later for TLS:
      # - ./letsencrypt:/etc/letsencrypt:ro
    restart: unless-stopped
    networks:
      - web

  # =========================
  # DATABASE MONITORING (PostgreSQL via Supabase Dashboard)
  # PostgreSQL databases are now managed by Supabase and can be accessed via:
  # - Supabase Dashboard (browser-based)
  # - psql command-line tool
  # - Any PostgreSQL client (pgAdmin, DBeaver, etc.)
  # =========================
  # Note: SQLite monitoring service removed - use Supabase dashboard for PostgreSQL monitoring

networks:
  web:
    driver: bridge

volumes:
  qdrant-storage:
