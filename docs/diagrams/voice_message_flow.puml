@startuml Chat Flow - Voice Message
!theme plain
skinparam sequenceMessageAlign center
skinparam roundcorner 20

actor User
participant "Telegram Bot" as Bot
participant "MessageHandlers" as Handler
participant "VoiceService\n(voice_service.py)" as Voice
participant "LLMHandler" as LLM
participant "Agent Graph" as Agent
participant "Translator" as Translator

User -> Bot: Send voice message
activate Bot

Bot -> Handler: on_voice(update, context)
activate Handler

Handler -> Bot: Download voice file
Bot --> Handler: Voice file path

Handler -> Voice: transcribe_voice_multi_language(\n  path,\n  user_language,\n  fallback_to_english\n)
activate Voice
Voice --> Handler: TranscriptionResult\n(text, language_code, confidence)
deactivate Voice

Handler -> Handler: Combine caption + transcription

Handler -> LLM: get_response_api(\n  transcribed_text,\n  user_id,\n  user_language\n)
activate LLM
LLM -> Agent: Process through agent graph
activate Agent
Agent --> LLM: Response
deactivate Agent
LLM --> Handler: llm_response
deactivate LLM

alt User language != English
    Handler -> Translator: translate_text(\n  response_text,\n  target_lang,\n  source_lang="en"\n)
    activate Translator
    Translator --> Handler: Translated response
    deactivate Translator
end

alt Voice mode enabled
    Handler -> Voice: synthesize_speech(\n  response_text,\n  speech_lang\n)
    activate Voice
    Voice --> Handler: Audio bytes
    deactivate Voice
    Handler -> User: Send voice response
else Voice mode disabled
    Handler -> User: Send text response
end

deactivate Handler
deactivate Bot

@enduml

