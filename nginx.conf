events {}

http {
    # DNS resolver for dynamic upstream resolution
    # Using Docker's internal DNS (127.0.0.11) with short TTL
    # This forces nginx to re-resolve DNS more frequently
    resolver 127.0.0.11 valid=10s ipv6=off;

    # 1) HTTP â†’ HTTPS redirect
    server {
        listen 80;
        server_name zana-ai.com www.zana-ai.com;

        return 301 https://$host$request_uri;
    }

    # 2) HTTPS server
    server {
        listen 443 ssl;
        server_name zana-ai.com www.zana-ai.com;

        ssl_certificate     /etc/letsencrypt/live/zana-ai.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/zana-ai.com/privkey.pem;

        # basic ssl settings (optional but fine)
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;

        location / {
            # Use variable in proxy_pass to force DNS resolution on each request
            # This prevents nginx from caching stale IP addresses
            set $backend "http://zana-webapp:8080";
            proxy_pass $backend;

            # Connection settings
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Standard proxy headers
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Retry on connection errors (note: with variable proxy_pass, 
            # proxy_next_upstream doesn't work, but resolver handles DNS refresh)
        }
    }
}
