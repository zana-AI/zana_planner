<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Watch in Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 8px; font-family: system-ui, sans-serif; background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
    .video-wrap { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; }
    .video-wrap iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .hint { font-size: 12px; color: var(--tg-theme-hint-color, #999); margin-top: 8px; }
  </style>
</head>
<body>
  <div class="video-wrap">
    <iframe id="yt" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
  </div>
  <p class="hint">When done, tap the button below to close and get your watch summary.</p>

  <script>
(function() {
  var videoId = new URLSearchParams(window.location.search).get('video_id') || '';
  var baseUrl = window.location.origin;
  var openTime = Date.now();
  var segments = [];
  var currentStart = null;
  var player = null;

  if (!videoId) {
    document.body.innerHTML = '<p>Missing video_id.</p>';
    return;
  }

  document.getElementById('yt').src = 'https://www.youtube.com/embed/' + videoId + '?enablejsapi=1';

  var tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  window.onYouTubeIframeAPIReady = function() {
    player = new YT.Player('yt', {
      events: {
        onStateChange: function(event) {
          if (event.data === YT.PlayerState.PLAYING) {
            currentStart = player.getCurrentTime();
          } else if ((event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) && currentStart != null) {
            var end = player.getCurrentTime();
            if (end > currentStart) segments.push([currentStart, end]);
            currentStart = null;
          }
        }
      }
    });
  };

  function getPayload(closedVia) {
    return {
      init_data: window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp.initData : '',
      stats: {
        video_id: videoId,
        time_spent_seconds: (Date.now() - openTime) / 1000,
        segments: segments,
        closed_via: closedVia
      }
    };
  }

  if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
    window.Telegram.WebApp.MainButton.setText('Done').show().onClick(function() {
      fetch(baseUrl + '/api/youtube/report_stats', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(getPayload('done'))
      }).then(function() {
        window.Telegram.WebApp.close();
      }).catch(function() {
        window.Telegram.WebApp.close();
      });
    });
  }

  window.addEventListener('pagehide', function() {
    navigator.sendBeacon(baseUrl + '/api/youtube/report_stats', JSON.stringify(getPayload('beacon')));
  });
})();
  </script>
</body>
</html>
